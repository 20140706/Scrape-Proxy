name: SOCKS5 Proxy Tester

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-proxies:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install requests[socks]
        
    - name: ðŸ§ª è¿è¡Œä»£ç†æµ‹è¯•
      timeout-minutes: 10
      run: python getProxySOCKS5.py
        
    - name: ðŸ“Š ä¸Šä¼ æµ‹è¯•ç»“æžœ
      uses: actions/upload-artifact@v4
      with:
        name: proxy-results
        path: |
          available_proxies.txt
          BEST_SOCKS5.txt
          proxy_results.json
          proxy_test.log
        
    - name: ðŸ“¤ æäº¤æ›´æ–°
      if: github.event_name != 'pull_request'
      run: |
        # ç¡®ä¿æ–‡ä»¶å­˜åœ¨
        touch available_proxies.txt
        touch BEST_SOCKS5.txt
        
        # è®¾ç½®Gité…ç½®
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ·»åŠ æ–‡ä»¶
        git add available_proxies.txt BEST_SOCKS5.txt
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff-index --quiet HEAD --; then
          echo "æ²¡æœ‰å˜åŒ–å¯æäº¤"
        else
          git commit -m "ðŸ¤– è‡ªåŠ¨æ›´æ–°ä»£ç†åˆ—è¡¨ [skip ci]"
          git push
        fi
        
    - name: ðŸ“‹ æ˜¾ç¤ºæµ‹è¯•ç»“æžœ
      run: |
        echo "=== æµ‹è¯•ç»“æžœ ==="
        echo "å¯ç”¨ä»£ç†æ•°: $(grep -c '^[0-9]' available_proxies.txt 2>/dev/null || echo 0)"
        echo "æœ€ä½³ä»£ç†: $(grep -v '^#' BEST_SOCKS5.txt 2>/dev/null || echo 'æ— ')"
